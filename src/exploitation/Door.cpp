#include <Common/usr_common.h>

#include <Common/internals/Image.h>
#include <libc/src/libc.h>

#ifdef DLL

extern "C"
_declspec(dllexport)
BOOL 
WINAPI
DllMain(
	__in HMODULE hModule,
	__in DWORD reason,
	__in LPVOID lpReserved
	);

extern "C"
__declspec(dllexport)
DWORD
WINAPI
UserLoader(
	__in void* base
	)
{
	CImage img(base);
	__debugbreak();
	CImage::FixRellocations(base, img.ImageBase());

	return DllMain(
		static_cast<HMODULE>(base), 
		DLL_PROCESS_ATTACH, 
		0);
}

#else

extern "C"
_declspec(dllexport)
void
WINAPI
Main();

extern "C"
_declspec(dllexport)
void
__fastcall
HijackedImage(
	__in void* base
	)
{
	CImage img(base);
	if (!img.FixRellocations(base, img.ImageBase()))
		return;

	Main();
}

#endif
